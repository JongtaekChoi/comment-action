name: Review Comment Format Checker

on:
  pull_request_review_comment:
    types: [created, edited, deleted]

jobs:
  check-comment-format:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      repository-projects: write

    steps:
      - name: Check format of review comment
        uses: actions/github-script@v7
        with:
          script: |
            console.log(context.payload);
            const comment = context.payload.comment;
            const regex = /^[pP][1-5]/;
            if (context.payload.comment.in_reply_to_id) {
              console.log('ì½”ë©˜íŠ¸ì˜ ì½”ë©˜íŠ¸ëŠ” ì•„ë¬´ê²ƒë„ ì•ˆí•¨')
              return;
            }

            const prInfo = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            }

            const reviewsResponse = await github.rest.pulls.listReviewComments(prInfo);
            const reviews = reviewsResponse.data;
            const warningComment = reviews.find(review => 
              review.in_reply_to_id == comment.id && review.user.login == 'github-actions[bot]'
            );

            if (!regex.test(comment.body)) {
              if (warningComment) {
                console.log('ì´ë¯¸ ê²½ê³  ì½”ë©˜íŠ¸ê°€ ì¡´ìž¬í•¨!');
                return;
              }
              const commentID = context.payload.comment.id;
              const message = `ðŸš¨ @${context.payload.comment.user.login}, Pn ë£°ì„ ë”°ë¥´ì§€ ì•ŠëŠ” ì½”ë©˜íŠ¸ìž…ë‹ˆë‹¤.`;

              github.rest.pulls.createReplyForReviewComment({
                ...prInfo,
                comment_id: commentID,
                body: message
              });
              return;
            } else if (warningComment) {
              await github.rest.pulls.deleteReviewComment({
                ...prInfo,
                comment_id: warningComment.id
              })
            }

            // clean up
            await Promise.all(
              reviews
                .filter(review => review.user.login == 'github-actions[bot]' && !review.in_reply_to_id)
                .map(comment => 
                  github.rest.pulls.deleteReviewComment({
                    ...prInfo,
                    comment_id: comment.id
                  })
                )
            )
